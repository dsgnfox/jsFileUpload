"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateMethodGet(e,t,i){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return i}var _createElement=new WeakSet,_changeHandler=new WeakSet,_addPreview=new WeakSet,_removeHandler=new WeakSet,_getFileSizeMb=new WeakSet,_createMessage=new WeakSet,_filesValidation=new WeakSet,CustomInputFile=function(){function e(t){var i=this;if(_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_filesValidation),_classPrivateMethodInitSpec(this,_createMessage),_classPrivateMethodInitSpec(this,_getFileSizeMb),_classPrivateMethodInitSpec(this,_removeHandler),_classPrivateMethodInitSpec(this,_addPreview),_classPrivateMethodInitSpec(this,_changeHandler),_classPrivateMethodInitSpec(this,_createElement),this.inputData={},this.inputData.files={},this.inputData.filesCount=0,this.inputData.filesSizeMb=0,this._vars={},this._elements={},this._error=!1,t&&t.input||(console.error("В опции не передан инпут или id"),this._error=!0),this._elements.form=t.input.closest("form"),this._elements.form||(console.error("Форма не найдена"),this._error=!0),!this._error){t.hasOwnProperty("error_remove_timeout")&&Number.isInteger(t.error_remove_timeout)?this._vars.errorRemoveTimeout=t.error_remove_timeout:this._vars.errorRemoveTimeout=5e3,t.hasOwnProperty("visible_btn_clear")?this._vars.visibleBtnClear=t.visible_btn_clear:this._vars.visibleBtnClear=!1,t.hasOwnProperty("accept")&&Array.isArray(t.accept)?this._vars.accept=t.accept:this._vars.accept=["image/jpg","image/jpeg","image/png","image/gif","application/pdf"],t.hasOwnProperty("max_file_count")&&Number.isInteger(t.max_file_count)?this._vars.maxFileCount=t.max_file_count:this._vars.maxFileCount=1,t.hasOwnProperty("max_all_file_size_mb")&&Number.isInteger(t.max_all_file_size_mb)?this._vars.maxAllFileSizeMb=t.max_all_file_size_mb:this._vars.maxAllFileSizeMb=1,t.hasOwnProperty("max_file_size_mb")&&Number.isInteger(t.max_file_size_mb)?this._vars.maxFileSizeMb=t.max_file_size_mb:this._vars.maxFileSizeMb=1,t.hasOwnProperty("has_preview_image")?this._vars.hasPreviewImage=t.has_preview_image:this._vars.hasPreviewImage=!1;var a="Вы можете прикрепить до ".concat(this._vars.maxFileCount," общим объемом ").concat(this._vars.maxAllFileSizeMb);t.hasOwnProperty("text_description")&&"string"==typeof t.text_description?this._vars.textDescription=t.text_description:this._vars.textDescription=a,this._elements.container=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","file-upload"),this._elements.btnAdd=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"button","add"),this._elements.btnAdd.setAttribute("type","button"),this._elements.btnAddContainer=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","controls__item, add-container"),this._elements.controls=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","controls"),t.hasOwnProperty("text_btn_add")?this._elements.btnAdd.textContent=t.text_btn_add:this._elements.btnAdd.textContent="Добавить файл",this._elements.btnAddContainer.insertAdjacentElement("beforeend",this._elements.btnAdd),this._elements.controls.insertAdjacentElement("beforeend",this._elements.btnAddContainer),this._elements.container.insertAdjacentElement("beforeend",this._elements.controls),this._vars.visibleBtnClear&&(this._elements.btnClear=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"button","clear"),this._elements.btnClearContainer=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","controls__item, clear-container"),this._elements.btnClear.setAttribute("type","button"),t.hasOwnProperty("text_btn_clear")?this._elements.btnClear.textContent=t.text_btn_clear:this._elements.btnClear.textContent="Удалить все файлы",this._elements.btnClear.addEventListener("click",function(e){return i.clearCustomFiles(i._elements.form)}),this._elements.btnClearContainer.insertAdjacentElement("beforeend",this._elements.btnClear),this._elements.controls.insertAdjacentElement("beforeend",this._elements.btnClearContainer)),this._elements.inputDescription=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","input-description"),this._elements.inputDescription.textContent=this._vars.textDescription,this._elements.container.insertAdjacentElement("beforeend",this._elements.inputDescription);var n=t.input;t.hasOwnProperty("multiple")&&t.multiple&&n.setAttribute("multiple",!0),n.setAttribute("name","filename[]"),n.setAttribute("accept",this._vars.accept),"file"!==n.getAttribute("type")&&n.setAttribute("type","file"),n.setAttribute("hidden",!0),n.insertAdjacentElement("afterend",this._elements.container),this._elements.btnAdd.addEventListener("click",function(e){return n.click()}),n.addEventListener("change",function(e){return _classPrivateMethodGet(i,_changeHandler,_changeHandler2).call(i,e)})}}return _createClass(e,[{key:"checkFileType",value:function(e){var t=e.type;return!!this._vars.accept.filter(function(e){return e===t}).length}},{key:"getCustomFiles",value:function(e){if(this._error||!e)return!1;for(var t in e.get("filename[]")&&e.delete("filename[]"),this.inputData.files)e.append("filename[]",this.inputData.files[t]);return e}},{key:"clearCustomFiles",value:function(){if(this._error)return!1;var e=this._elements.form.querySelector(".file-list"),t=this._elements.form.querySelector(".message-container");if(this.inputData.files)for(var i in this.inputData.files)delete this.inputData.files[i];this.inputData.filesCount=0,this.inputData.filesSizeMb=0,e&&e.remove(),t&&t.remove()}}]),e}();function _createElement2(e,t){var i=document.createElement(e);t&&t.replace(/\s/g,"").split(",").forEach(function(e){i.classList.add(e)});return i}function _changeHandler2(e){var t=this,i=Array.from(e.target.files);if(!i.length)return!1;var a=_classPrivateMethodGet(this,_filesValidation,_filesValidation2).call(this,i);a.status?i.forEach(function(e){t.inputData.files[e.name]=e,_classPrivateMethodGet(t,_addPreview,_addPreview2).call(t,e)}):_classPrivateMethodGet(this,_createMessage,_createMessage2).call(this,a.message,a.type),e.target.value=""}function _addPreview2(e){var t=this;if(!this._elements.form.querySelector(".file-list")){var i=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","file-list");this._elements.controls.insertAdjacentElement("afterend",i)}var a=new FileReader;a.addEventListener("load",function(i){var a=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item, ".concat(e.type.replace(/[\\.\\/]/g,"-")));if(a.setAttribute("data-file-name",e.name),t._vars.hasPreviewImage){var n=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item__aside"),s=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item__preview");s.setAttribute("style","background-image: url(".concat(i.target.result,")")),n.insertAdjacentElement("beforeend",s),a.insertAdjacentElement("beforeend",n)}var r=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item__main"),l=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item__name");l.textContent=e.name;var c=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item__size");c.textContent="".concat(_classPrivateMethodGet(t,_getFileSizeMb,_getFileSizeMb2).call(t,e)," Мб");var o=_classPrivateMethodGet(t,_createElement,_createElement2).call(t,"div","file-item__remove");o.addEventListener("click",function(i){return _classPrivateMethodGet(t,_removeHandler,_removeHandler2).call(t,i,e)});var _=t._elements.form.querySelector(".file-list");r.insertAdjacentElement("beforeend",l),r.insertAdjacentElement("beforeend",c),r.insertAdjacentElement("beforeend",o),a.insertAdjacentElement("beforeend",r),_.insertAdjacentElement("beforeend",a)}),this.inputData.filesCount=++this.inputData.filesCount,a.readAsDataURL(e)}function _removeHandler2(e){var t=e.target.closest(".file-item"),i=t.dataset.fileName,a=_classPrivateMethodGet(this,_getFileSizeMb,_getFileSizeMb2).call(this,this.inputData.files[i]);delete this.inputData.files[i],t.remove(),this.inputData.filesCount=--this.inputData.filesCount,this.inputData.filesSizeMb-=a}function _getFileSizeMb2(e){var t=e.size;return 0===t?0:Math.ceil(t/1048576)}function _createMessage2(e,t){var i=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","message-container"),a=_classPrivateMethodGet(this,_createElement,_createElement2).call(this,"div","message-container__text, message-container__text--".concat(t));a.textContent=e,i.insertAdjacentElement("beforeend",a),this._elements.container.insertAdjacentElement("beforeend",i),setTimeout(function(){i.remove()},this._vars.errorRemoveTimeout)}function _filesValidation2(e){var t=this,i={message:"",type:"",status:!0};return e.length>this._vars.maxFileCount-this.inputData.filesCount?(i.status=!1,i.type="error",i.message="Превышено количество файлов",i):(e.forEach(function(e){var a=_classPrivateMethodGet(t,_getFileSizeMb,_getFileSizeMb2).call(t,e);t.inputData.filesSizeMb+=a,a>=t._vars.maxFileSizeMb&&(i.status=!1,i.type="error",i.message="Вес файла ".concat(e.name," больше разрешенного")),t.checkFileType(e)||(i.status=!1,i.type="error",i.message="Нельзя загружать файлы с расширением ".concat(e.type)),t.inputData.files[e.name]&&(i.status=!1,i.type="error",i.message="Файл ".concat(e.name," уже был выбран"))}),i.status?this.inputData.filesSizeMb>=this._vars.maxAllFileSizeMb?(i.type="error",i.message="Превышено общий вес файлов",i):(i.type="success",i.status=!0,i):i)}